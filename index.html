<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Programme Hebdo ‚Äî v1.6.7 (fix recettes + focus/minuteur)</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e1224">

<style>
/* ====== Th√®me & base (identique) ====== */
:root{
  --bg:#0e1224; --ink:#eef2ff; --muted:#a5b4fc; --card:#121735; --panel:#161d44; --border:#26306b;
  --accent:#7dd3fc; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --ring:0 0 0 2px rgba(125,211,252,.45);
}
*{box-sizing:border-box}
html,body{margin:0;background:linear-gradient(180deg,#0e1224,#0a0f21 70%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
a{color:inherit}

/* ====== En-t√™te statique (comme avant) ====== */
header.sticky{
  position: static;
  z-index: 10;
  background:rgba(14,18,36,.85);
  backdrop-filter:saturate(1.1) blur(8px);
  border-bottom:1px solid rgba(255,255,255,.07);
  padding-top: env(safe-area-inset-top);
}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
.headbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 20px}
.brand{display:flex;gap:10px;align-items:center}
.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 6px rgba(34,197,94,.25)}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{background:var(--panel);border:1px solid var(--border);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
.btn:hover{outline:var(--ring)}

.days{display:grid;grid-template-columns:repeat(9,1fr);gap:8px;padding:8px 20px 14px}
.days button{border:1px solid var(--border);background:var(--card);color:var(--ink);padding:8px;border-radius:10px;cursor:pointer;font-weight:700}
.days button.active{background:linear-gradient(180deg,#1a2146,#121838);outline:var(--ring)}

.grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
@media(max-width:950px){.grid{grid-template-columns:1fr}}

.card{background:linear-gradient(180deg,#141a3a,#111633);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.28)}
.card h2{margin:0 0 10px;font-size:20px}
.tag{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:12px}
.section-title{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}

/* ====== EXERCICES ====== */
.exo{display:grid;grid-template-columns:1fr auto;gap:8px;padding:12px 0;border-top:1px dashed rgba(255,255,255,.08)}
.exo:first-child{border-top:none}
.exo h3{margin:0;font-size:16px;display:flex;align-items:center;gap:8px}
.info-badge{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;font-weight:900;font-size:11px;background:#0e1430;border:1px solid rgba(255,255,255,.18);color:#a6d6ff;line-height:1;text-decoration:none}
.info-badge:hover{outline:var(--ring)}
.meta{color:#b9c1ff;font-size:13px;display:flex;gap:8px;flex-wrap:wrap}
.meta .chip{padding:2px 8px;border:1px solid rgba(255,255,255,.14);border-radius:999px}
.sets{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-self:end}
.chk{display:flex;align-items:center;gap:6px;background:#0e1430;border:1px solid var(--border);border-radius:999px;padding:4px 8px}
.chk input{accent-color:var(--ok);transform:scale(1.1)}

/* ====== RECETTES (fix ‚Äúen long‚Äù) ====== */
.rec{display:grid;grid-template-columns:110px 1fr;gap:12px;padding:12px 0;border-top:1px dashed rgba(255,255,255,.08)}
.rec:first-child{border-top:none}
.tile{width:110px;height:110px;border-radius:14px;border:1px solid var(--border);background:radial-gradient(95px 75px at 60% 20%,rgba(125,211,252,.25),transparent 60%),linear-gradient(180deg,#151b3f,#0f1533)}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.pill{background:rgba(125,211,252,.12);border:1px solid rgba(125,211,252,.25);color:#c0ecff;padding:6px 10px;border-radius:999px;font-size:12px}

/* >>> Ces 3 r√®gles emp√™chent les coupures moches et forcent un paragraphe ‚Äúen long‚Äù */
.rec h3, .line{white-space:normal; word-break:normal; overflow-wrap:anywhere}
.line{margin-top:6px;color:#dbe6ff;font-size:14px;line-height:1.55;letter-spacing:.2px}

.ings{margin-top:6px;color:#bcd1ff;font-size:12px}
.ings .t{display:inline-block;margin:3px 6px 0 0;padding:4px 8px;border:1px solid rgba(255,255,255,.12);border-radius:8px;background:#0f1434}

/* ====== Donuts macros (identique) ====== */
.donut{position:relative;width:110px;height:110px}
svg{display:block}
.donut .mid{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:13px;color:#dfe6ff}
.swatch{display:flex;gap:6px;align-items:center}
.swatch::before{content:"";width:10px;height:10px;border-radius:2px;display:inline-block}
.swatch.p::before{background:#60a5fa}.swatch.l::before{background:#f472b6}.swatch.g::before{background:#fbbf24}

/* ====== MODALES (Focus / Minuteur‚Ä¶) ====== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
.modal.open{display:flex}
.modal .box{max-width:900px;background:linear-gradient(180deg,#141a3a,#111633);border:1px solid var(--border);border-radius:16px;padding:16px;max-height:90vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,.45);position:relative}
.mod-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:880px){.mod-grid{grid-template-columns:1fr}}

/* ====== STYLE ‚ÄúFOCUS S√âANCE‚Äù (nouveau) ====== */
.focusTitle{margin:4px 0 6px;font-size:18px}
.focusMeta{color:#b9c1ff;font-size:13px;margin-bottom:8px}
#fBody .bubble{
  width:40px;height:40px;border-radius:12px;display:grid;place-items:center;
  background:#0e1430;border:1px solid var(--border);color:#8fb7ff;font-weight:800;margin:6px;cursor:pointer;
  box-shadow:inset 0 -1px 0 rgba(255,255,255,.06)
}
#fBody .bubble.done{
  background:linear-gradient(180deg,#203468,#1a2a52);border-color:#3e63f3;color:#fff;
  box-shadow:inset 0 0 0 2px rgba(100,149,237,.25)
}
#fBody .focusTimer{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
#fBody .focusTimer .small{color:#a8b3ff;font-size:12px}
#fBody .focusTimer button,
#fPrev,#fNext,#fResetExo{
  background:var(--panel);border:1px solid var(--border);color:var(--ink);
  padding:8px 10px;border-radius:10px;cursor:pointer
}
#fBody .progress{margin-top:8px;color:#cfe3ff}

/* ====== MINUTEUR (nouveau style) ====== */
.timer{display:grid;gap:10px;justify-items:center}
.display{
  font-variant-numeric:tabular-nums;
  font-size:38px;font-weight:800;letter-spacing:.5px;
  padding:8px 14px;border-radius:12px;background:#0e1430;border:1px solid var(--border)
}
.preset{display:flex;gap:8px;flex-wrap:wrap}
.tbtn{
  background:var(--panel);border:1px solid var(--border);color:var(--ink);
  padding:8px 10px;border-radius:10px;cursor:pointer
}
.tbtn:hover,.btn:hover{outline:var(--ring)}

/* ====== Tableaux / formulaires (idem) ====== */
.note{color:#cdd6ff;font-size:13px}
.form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.form{grid-template-columns:1fr}}
.form input[type=number], .form input[type=date], .form textarea{
  width:100%;background:#0e1430;border:1px solid var(--border);border-radius:10px;color:var(--ink);padding:8px 10px
}
.range{accent-color:var(--accent);width:100%}
.table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px;display:block;overflow-x:auto}
.table th,.table td{border:1px solid rgba(255,255,255,.08);padding:6px 8px;white-space:nowrap}
.table th{background:rgba(255,255,255,.06);text-align:left}

/* iPhone */
@supports(padding: env(safe-area-inset-top)) {
  header.sticky { padding-top: env(safe-area-inset-top); }
  footer       { padding-bottom: env(safe-area-inset-bottom); }
}
@media (max-width: 900px){
  .days{display:flex !important;gap:8px;overflow-x:auto;padding:8px 12px 14px}
  .days::-webkit-scrollbar{display:none}
  .days button{flex:0 0 auto;min-width:68px;padding:10px 12px}
}
</style>
</head>
<body>
<!-- ====== ENT√äTE ====== -->
<header class="sticky">
  <div class="headbar">
    <div class="brand"><span class="dot"></span><strong>Transformation ‚Äî Semaine type (utilisable)</strong></div>
    <div class="actions">
      <div class="hud">
        <span class="level">Niv. <span id="level">1</span></span>
        <div class="xpbar" style="position:relative;width:220px;height:10px;border-radius:999px;background:#0e1430;border:1px solid var(--border);overflow:hidden"><span id="xpfill" style="position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#60a5fa,#22c55e);width:0%"></span></div>
        <span class="streak" style="display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;color:#ffd29a">üî• Streak : <span id="streak">0</span> j</span>
      </div>
      <button class="btn" id="btnFocus">Focus s√©ance</button>
      <button class="btn" id="btnGroceries">Courses</button>
      <button class="btn" id="btnTimer">Minuteur repos</button>
      <button class="btn" id="btnBadges">Badges</button>
      <button class="btn" id="btnSupp">Compl√©ments</button>
      <button class="btn" id="btnReset">R√©initialiser les s√©ries (jour affich√©)</button>
    </div>
  </div>
  <nav class="days" id="nav">
    <button data-day="1" class="active">Lun</button>
    <button data-day="2">Mar</button>
    <button data-day="3">Mer</button>
    <button data-day="4">Jeu</button>
    <button data-day="5">Ven</button>
    <button data-day="6">Sam</button>
    <button data-day="7">Dim</button>
    <button data-day="checkin">Check-in</button>
    <button data-day="infos">Infos</button>
  </nav>
</header>

<main class="wrap">
  <!-- ====== J1 (exemple ‚Äî les autres jours identiques √† ta version) ====== -->
  <section class="day" data-day="1">
    <div class="grid">
      <article class="card">
        <div class="section-title"><h2>Jour 1 ‚Äî Full-Body A (45‚Äì60‚Äô)</h2><span class="tag">Force de base + technique</span></div>

        <div class="exo">
          <div>
            <h3>Goblet Squat <a class="info-badge" href="https://www.youtube.com/results?search_query=goblet+squat" target="_blank" rel="noopener">‚ìò</a></h3>
            <p class="meta"><span class="chip">4√ó8‚Äì12</span><span class="chip">RPE 7‚Äì8</span><span class="chip">Tempo 3‚Äì1‚Äì2</span><span class="chip">Repos 90s</span></p>
            <details><summary>Comment faire</summary>
              <ul class="note"><li>Pieds largeur √©paules, halt√®re au torse.</li><li>Descends 3s (cuisses //), stop 1s, remonte 2s.</li><li>Genoux dans l‚Äôaxe, talons au sol, abdos gain√©s.</li></ul>
            </details>
          </div>
          <div class="sets" data-sets="4" data-key="d1-goblet"></div>
        </div>

        <div class="exo"><div><h3>D√©velopp√© couch√© halt√®res <a class="info-badge" href="https://www.youtube.com/results?search_query=dumbbell+bench+press" target="_blank" rel="noopener">‚ìò</a></h3><p class="meta"><span class="chip">4√ó8‚Äì12</span><span class="chip">Tempo 2‚Äì1‚Äì2</span><span class="chip">Repos 90s</span></p></div><div class="sets" data-sets="4" data-key="d1-bench"></div></div>
        <div class="exo"><div><h3>Tractions assist√©es / n√©gatives <a class="info-badge" href="https://www.youtube.com/results?search_query=negative+pull+ups" target="_blank" rel="noopener">‚ìò</a></h3><p class="meta"><span class="chip">5√ó3‚Äì5</span><span class="chip">Tempo 0‚Äì1‚Äì5</span><span class="chip">Repos 90s</span></p></div><div class="sets" data-sets="5" data-key="d1-pullups"></div></div>
        <div class="exo"><div><h3>RDL ‚Äî halt√®res <a class="info-badge" href="https://www.youtube.com/results?search_query=dumbbell+romanian+deadlift" target="_blank" rel="noopener">‚ìò</a></h3><p class="meta"><span class="chip">3√ó10‚Äì12</span><span class="chip">Tempo 3‚Äì1‚Äì2</span><span class="chip">Repos 90s</span></p></div><div class="sets" data-sets="3" data-key="d1-rdl"></div></div>
        <div class="exo"><div><h3>Row unilat√©ral banc <a class="info-badge" href="https://www.youtube.com/results?search_query=one+arm+dumbbell+row" target="_blank" rel="noopener">‚ìò</a></h3><p class="meta"><span class="chip">3√ó12/bras</span><span class="chip">Tempo 2‚Äì1‚Äì2</span><span class="chip">Repos 75s</span></p></div><div class="sets" data-sets="3" data-key="d1-row"></div></div>
        <div class="exo"><div><h3>Dead Bug <a class="info-badge" href="https://www.youtube.com/results?search_query=dead+bug+exercise" target="_blank" rel="noopener">‚ìò</a></h3><p class="meta"><span class="chip">3√ó8/c√¥t√©</span><span class="chip">Contr√¥le</span><span class="chip">Repos 45s</span></p></div><div class="sets" data-sets="3" data-key="d1-deadbug"></div></div>
      </article>

      <article class="card">
        <div class="section-title"><h2>Repas du jour (2 au choix)</h2><span class="tag">Cible : ~170‚Äì190 g prots/j</span></div>

        <div class="rec">
          <div class="tile"><div class="donut" data-p="55" data-l="12" data-g="35" data-k="510"></div></div>
          <div>
            <h3>Salade poulet croquante (‚âà15‚Äô)</h3>
            <div class="kpi"><span class="pill">~510 kcal</span><span class="pill">P 55 g</span><span class="pill">L 12 g</span><span class="pill">G 35 g</span></div>
            <div class="ings"><span class="t">Poulet 180 g</span><span class="t">salade</span><span class="t">tomate</span><span class="t">concombre</span><span class="t">ma√Øs 60 g</span><span class="t">yaourt 0% 150 g</span><span class="t">citron</span><span class="t">herbes</span></div>
            <p class="line">Saisir le poulet 6‚Äì8 min; m√©langer l√©gumes + yaourt + citron + herbes; ajouter le poulet, m√©langer, servir frais.</p>
          </div>
        </div>

        <div class="rec">
          <div class="tile"><div class="donut" data-p="45" data-l="16" data-g="60" data-k="600"></div></div>
          <div>
            <h3>Chili express (batch 2 portions)</h3>
            <div class="kpi"><span class="pill">~600 kcal/portion</span><span class="pill">P 45 g</span><span class="pill">L 16 g</span><span class="pill">G 60 g</span></div>
            <div class="ings"><span class="t">B≈ìuf 5% 300 g</span><span class="t">haricots rouges 240 g</span><span class="t">tomate 400 g</span><span class="t">oignon</span><span class="t">√©pices</span></div>
            <p class="line">Suer oignon et √©pices 2‚Äì3 min; saisir le b≈ìuf 4‚Äì5 min; ajouter tomate et haricots; mijoter 15‚Äì20 min jusqu‚Äô√† √©paississement.</p>
          </div>
        </div>

        <p class="note">R√®gle : 30‚Äì45 g de prot√©ines/repas ‚Ä¢ l√©gumes √† volont√© ‚Ä¢ eau 3‚Äì4 L.</p>
      </article>
    </div>
  </section>

  <!-- Les autres jours / check-in / infos : garde tes blocs actuels identiques -->
  <!-- ‚Ä¶ -->
</main>

<!-- ====== MODALES Focus / Minuteur (structure identique, style mis √† jour via CSS ci-dessus) ====== -->
<div class="modal" id="modalFocus" aria-hidden="true">
  <div class="box" style="max-width:760px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
      <h2 class="focusTitle">Focus ‚Äî <span id="fDay">Jour ?</span></h2>
      <button class="btn" id="closeFocus">Fermer</button>
    </div>
    <div id="fBody"></div>
  </div>
</div>

<div class="modal" id="modalTimer" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px">
      <h2 style="margin:0">Minuteur de repos</h2>
      <button class="btn" id="closeTimer">Fermer</button>
    </div>
    <div class="timer">
      <div class="display" id="tDisplay">00:00</div>
      <div class="preset">
        <button class="tbtn" data-sec="30">30 s</button>
        <button class="tbtn" data-sec="60">60 s</button>
        <button class="tbtn" data-sec="90">90 s</button>
      </div>
      <div class="preset">
        <button class="tbtn" id="tStart">D√©marrer</button>
        <button class="tbtn" id="tStop">Stop</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== NAV (identique) ====== */
const nav=document.getElementById('nav');
const btns=[...nav.querySelectorAll('button')];
const days=[...document.querySelectorAll('.day')];
nav.addEventListener('click',e=>{
  if(e.target.tagName!=='BUTTON')return;
  const d=e.target.getAttribute('data-day');
  btns.forEach(b=>b.classList.toggle('active',b===e.target));
  days.forEach(sec=>sec.hidden = sec.getAttribute('data-day')!==d);
  try{ e.target.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'}); }catch{}
  window.scrollTo({ top: 0 });
});

/* ====== HUD / XP (identique) ====== */
function getDB(){ try{return JSON.parse(localStorage.getItem('xpdb_v1')||'{}')}catch{return{}} }
function setDB(db){ localStorage.setItem('xpdb_v1', JSON.stringify(db)) }
function addXP(amount){
  const db=getDB();
  db.xp=Math.max(0,(db.xp||0)+amount);
  const today=new Date(); const dstr=today.toISOString().slice(0,10);
  if(amount>0){
    if(db.lastActionDate!==dstr){
      const y=new Date(today); y.setDate(today.getDate()-1);
      const ystr=y.toISOString().slice(0,10);
      db.streak = (db.lastActionDate===ystr)? (db.streak||0)+1 : 1;
      db.lastActionDate=dstr;
    }
  }
  setDB(db); renderHUD();
}
function renderHUD(){ const db=getDB(); const xp=db.xp||0; const lvl=Math.floor(xp/100)+1; const pct=(xp%100); document.getElementById('level').textContent=lvl; document.getElementById('xpfill').style.width=`${pct}%`; document.getElementById('streak').textContent=db.streak||0; }
renderHUD();

/* ====== S√©ries (XP ¬±5) ====== */
function renderSets(){
  document.querySelectorAll('.sets').forEach(box=>{
    const n=+box.dataset.sets||3;
    const key=box.dataset.key;
    const saved=(localStorage.getItem(key)||'').split('').map(x=>x==='1');
    box.innerHTML='';
    for(let i=0;i<n;i++){
      const lbl=document.createElement('label'); lbl.className='chk';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!saved[i];
      cb.addEventListener('change',()=>{
        const arr=[...box.querySelectorAll('input')].map(x=>x.checked?'1':'0');
        localStorage.setItem(key,arr.join(''));
        addXP(cb.checked?+5:-5);
      });
      const span=document.createElement('span'); span.textContent=`S${i+1}`;
      lbl.appendChild(cb); lbl.appendChild(span); box.appendChild(lbl);
    }
  });
}
renderSets();
document.getElementById('btnReset').addEventListener('click',()=>{
  const current = btns.find(b=>b.classList.contains('active')).getAttribute('data-day');
  document.querySelectorAll(`section.day[data-day="${current}"] .sets`).forEach(box=>localStorage.removeItem(box.dataset.key));
  renderSets(); alert('S√©ries r√©initialis√©es pour le jour affich√©.');
});

/* ====== Donuts macros ====== */
function createDonut(el){
  const P=+el.dataset.p, L=+el.dataset.l, G=+el.dataset.g, K=el.dataset.k;
  const tot=Math.max(P+L+G,1);
  const p=Math.round(P/tot*100), l=Math.round(L/tot*100), g=100-p-l, C=2*Math.PI*50;
  el.innerHTML = `
    <svg viewBox="0 0 120 120" width="110" height="110" aria-hidden="true">
      <circle cx="60" cy="60" r="50" stroke="#0c1330" stroke-width="16" fill="none"/>
      <g transform="rotate(-90 60 60)">
        <circle cx="60" cy="60" r="50" stroke="#60a5fa" stroke-width="16" fill="none" stroke-dasharray="${(p/100)*C} ${C}" />
        <circle cx="60" cy="60" r="50" stroke="#f472b6" stroke-width="16" fill="none" stroke-dasharray="${(l/100)*C} ${C}" stroke-dashoffset="-${(p/100)*C}" />
        <circle cx="60" cy="60" r="50" stroke="#fbbf24" stroke-width="16" fill="none" stroke-dasharray="${(g/100)*C} ${C}" stroke-dashoffset="-${((p+l)/100)*C}" />
      </g>
    </svg>
    <div class="mid">${K}<br><span style="font-size:11px;color:#bcd0ff">kcal</span></div>`;
}
document.querySelectorAll('.donut').forEach(createDonut);

/* ====== Minuteur ====== */
const modalTimer=document.getElementById('modalTimer');
const tDisplay=document.getElementById('tDisplay');
let tRemaining=0, tHandle=null;
function fmt(s){const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`}
function setTime(s){tRemaining=s; tDisplay.textContent=fmt(s)}
function tick(){
  if(tRemaining<=0){ clearInterval(tHandle); tHandle=null; try{navigator.vibrate&&navigator.vibrate([120,80,120]);}catch{} tDisplay.textContent='00:00'; return; }
  tRemaining--; tDisplay.textContent=fmt(tRemaining);
}
document.getElementById('btnTimer').addEventListener('click',()=>{ setTime(60); openModal(modalTimer); });
document.getElementById('closeTimer').addEventListener('click',()=>{ closeModal(modalTimer); if(tHandle){clearInterval(tHandle);tHandle=null;} });
modalTimer.addEventListener('click',e=>{ if(e.target===modalTimer){ closeModal(modalTimer); if(tHandle){clearInterval(tHandle);tHandle=null;} }});
document.querySelectorAll('.tbtn[data-sec]').forEach(b=>b.addEventListener('click',()=>setTime(+b.dataset.sec)));
document.getElementById('tStart').addEventListener('click',()=>{ if(tHandle) clearInterval(tHandle); tHandle=setInterval(tick,1000) });
document.getElementById('tStop').addEventListener('click',()=>{ if(tHandle){clearInterval(tHandle);tHandle=null;} });

/* ====== Focus s√©ance (avec bulles styl√©es) ====== */
const modalFocus=document.getElementById('modalFocus');
const fDay=document.getElementById('fDay');
const fBody=document.getElementById('fBody');
let FCTX=null;

function openModal(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
function closeModal(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }

document.getElementById('btnFocus').addEventListener('click',()=>{
  FCTX=buildFocusFromDay(); openModal(modalFocus); focusRender();
});
document.getElementById('closeFocus').addEventListener('click',()=>closeModal(modalFocus));
modalFocus.addEventListener('click',e=>{ if(e.target===modalFocus) closeModal(modalFocus) });

function currentDaySection(){ const b=btns.find(b=>b.classList.contains('active')); return document.querySelector(`section.day[data-day="${b.getAttribute('data-day')}"]`) }
function buildFocusFromDay(){
  const sec=currentDaySection(); const dayLabel=btns.find(b=>b.classList.contains('active')).textContent;
  const exos=[...sec.querySelectorAll('.grid .card:first-child .exo')].map(ex=>{
    const name=ex.querySelector('h3')?.textContent.replace('‚ìò','').trim()||'Exercice';
    const meta=ex.querySelector('.meta')?.textContent||'';
    const sets=+ex.querySelector('.sets')?.dataset.sets||3;
    const key=ex.querySelector('.sets')?.dataset.key||('key-'+name);
    const tips=ex.querySelector('details')?.outerHTML||'';
    return {name, meta, sets, key, tips};
  });
  return {dayLabel, exos, idx:0};
}
function getSetState(key, n){ const s=(localStorage.getItem(key)||'').split(''); const arr=[]; for(let i=0;i<n;i++) arr.push(s[i]==='1'); return arr }
function setSetState(key, arr){ localStorage.setItem(key, arr.map(x=>x?'1':'0').join('')); renderSets(); }
function focusRender(){
  if(!FCTX){ fBody.innerHTML='<p class="note">Aucun exercice trouv√©.</p>'; return; }
  const ex=FCTX.exos[FCTX.idx];
  const doneArr=getSetState(ex.key, ex.sets);
  const doneCount=doneArr.filter(Boolean).length;
  fDay.textContent = `Jour ${btns.find(b=>b.classList.contains('active')).textContent} ‚Äî Exercice ${FCTX.idx+1}/${FCTX.exos.length}`;
  fBody.innerHTML=`
    <h3 class="focusTitle">${ex.name}</h3>
    <div class="focusMeta">${ex.meta}</div>
    ${ex.tips||''}
    <div id="fSet" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px"></div>
    <div class="progress">S√©ries : <b>${doneCount}</b> / ${ex.sets}</div>
    <div class="focusTimer">
      <span class="small">Repos rapide :</span>
      <button class="tbtn" data-sec="30">30s</button>
      <button class="tbtn" data-sec="60">60s</button>
      <button class="tbtn" data-sec="90">90s</button>
      <button class="tbtn" id="fNextSet">Valider une s√©rie</button>
    </div>
    <div class="fNav" style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:10px">
      <button class="btn" id="fPrev">‚Üê Pr√©c√©dent</button>
      <button class="btn" id="fResetExo">R√©initialiser l‚Äôexercice</button>
      <button class="btn" id="fNext">${doneCount===ex.sets?'Suivant ‚Üí':'Suivant (apr√®s s√©ries)'}</button>
    </div>
  `;
  const holder=document.getElementById('fSet');
  for(let i=0;i<ex.sets;i++){
    const b=document.createElement('div'); b.className='bubble'+(doneArr[i]?' done':''); b.textContent=i+1;
    b.addEventListener('click',()=>{ const newVal=!doneArr[i]; doneArr[i]=newVal; setSetState(ex.key,doneArr); addXP(newVal?+5:-5); b.classList.toggle('done',newVal); });
    holder.appendChild(b);
  }
  document.querySelectorAll('#fBody .tbtn[data-sec]').forEach(b=>b.addEventListener('click',()=>{ setTime(+b.dataset.sec); openModal(modalTimer); }));
  document.getElementById('fNextSet').onclick=()=>{
    const i=doneArr.findIndex(v=>!v);
    if(i>-1){ doneArr[i]=true; setSetState(ex.key,doneArr); addXP(5); focusRender(); }
  }
  document.getElementById('fPrev').onclick=()=>{ if(FCTX.idx>0){FCTX.idx--; focusRender();} }
  document.getElementById('fResetExo').onclick=()=>{ setSetState(ex.key, new Array(ex.sets).fill(false)); focusRender(); }
  document.getElementById('fNext').onclick=()=>{ if(doneArr.every(Boolean) && FCTX.idx<FCTX.exos.length-1){FCTX.idx++; focusRender();} else if(!doneArr.every(Boolean)){ alert('Valide toutes les s√©ries avant de passer au suivant.'); } else { closeModal(modalFocus); alert('S√©ance termin√©e. GG !'); } }
}

/* ====== PWA: SW ====== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  });
}
</script>
</body>
</html>
