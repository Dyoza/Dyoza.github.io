<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#0f172a"/>
<title>Santé • Changement — v1.2+</title>
<style>
  :root{
    --bg:#0b1220; --card:#11182a; --muted:#93a4bc; --ink:#e7eefc; --accent:#66d9a3;
    --danger:#ff6b6b; --gold:#ffd166; --brand:#4f46e5;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,#0b1220,#0d1528);color:var(--ink);font:500 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:#8dd3ff;text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:84px 16px 80px}
  /* Header sticky simple & fiable */
  header.appbar{
    position:sticky; top:0; z-index:1000; backdrop-filter:blur(10px);
    background:rgba(9,14,28,.75); border-bottom:1px solid rgba(255,255,255,.06)
  }
  .appbar .row{display:flex; gap:10px; align-items:center; padding:10px 12px}
  .brand{font-weight:800; letter-spacing:.3px}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{
    padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:10px;cursor:pointer;
    background:rgba(255,255,255,.04); color:#cfe3ff; font-weight:600; font-size:13px
  }
  .tab.active{background:linear-gradient(180deg,#1a2440,#141d34); border-color:rgba(255,255,255,.14); color:#fff}
  .pill{padding:2px 8px;border-radius:999px;background:#172036;border:1px solid rgba(255,255,255,.08); font-size:12px;color:#afc6e9}

  /* Layout jour = exercices à gauche, recettes à droite */
  .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:16px}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,#0e162a,#0b1220);
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.25)
  }
  .card h2{margin:0 0 10px; font-size:20px}
  .card section+section{margin-top:14px;border-top:1px dashed rgba(255,255,255,.08); padding-top:14px}

  /* Exos */
  .exo{padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.06)}
  .exo:last-child{border-bottom:none}
  .exo h3{margin:0 0 6px; font-size:16px; display:flex; align-items:center; gap:8px}
  .info{display:inline-block; font-weight:800; font-size:12px; line-height:1; padding:1px 6px;
        border-radius:999px; background:#10213a; border:1px solid rgba(255,255,255,.12); color:#a8d1ff}
  .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:12px}
  .meta .chip{padding:3px 8px; border:1px solid rgba(255,255,255,.09); border-radius:999px}
  .series{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
  .bubble{
    width:38px; height:38px; border-radius:11px; display:grid; place-items:center; cursor:pointer;
    border:1px solid rgba(255,255,255,.12); background:#0d162b; color:#8fb7ff; font-weight:700
  }
  .bubble.done{background:linear-gradient(180deg,#1e2c50,#18233e); border-color:#3c6df0; color:#fff; box-shadow:inset 0 0 0 2px rgba(100,149,237,.25)}
  .rest{font-size:12px; color:#9ab3d6; margin-left:2px}

  /* Recettes */
  .recipe h3{margin:0 0 8px; font-size:16px}
  .macros{display:flex; gap:8px; flex-wrap:wrap}
  .macro{padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.08); color:#d7e7ff; font-size:12px}
  .note{margin-top:8px; color:#cfe3ff; font-size:14px}
  .note .dot{opacity:.5; margin:0 .5ch}
  .ings{margin-top:8px; color:#bcd1ec; font-size:13px}
  .ings .tag{display:inline-block; margin:3px 6px 0 0; padding:4px 8px; border-radius:999px; background:#172036; border:1px solid rgba(255,255,255,.07)}

  /* Courses */
  .list{display:grid; gap:8px}
  .row{display:flex; align-items:center; gap:10px; justify-content:space-between}
  .row label{display:flex; align-items:center; gap:10px}
  .price{font-size:13px; color:#cfe3ff}
  .muted{color:var(--muted)}
  .tot{margin-top:10px; font-weight:800}
  .edit{margin-left:6px; padding:3px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:#13203a; color:#cde0ff; font-size:12px}
  input[type="number"].mini{width:80px; background:#0f1a30; color:#e9f2ff; border:1px solid rgba(255,255,255,.12); padding:4px 6px; border-radius:8px}

  /* Footer XP */
  footer.bar{
    position:fixed; bottom:0; left:0; right:0; z-index:1000; background:rgba(9,14,28,.85);
    border-top:1px solid rgba(255,255,255,.08); display:flex; gap:12px; align-items:center; padding:8px 12px
  }
  .xpbar{flex:1; height:12px; background:#0f1a2e; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .xpbar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#3f8cff,#66d9a3)}
  .bt{padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#13203a; color:#d7e9ff; cursor:pointer; font-weight:700; font-size:13px}

  /* Helpers */
  .hide{display:none}
  .ok{color:#8effc1}
  .warn{color:#ffd166}
</style>
</head>
<body>
<header class="appbar" role="navigation" aria-label="Navigation principale">
  <div class="row">
    <div class="brand">Santé • Changement</div>
    <div class="pill" id="dayTag">Jour 1</div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-go="jour">Jours</button>
      <button class="tab" data-go="focus">Focus séance</button>
      <button class="tab" data-go="courses">Courses</button>
      <button class="tab" data-go="timer">Minuteur repos</button>
      <button class="tab" data-go="checkin">Check-in (20–22h)</button>
      <button class="tab" data-go="badges">Badges</button>
      <button class="tab" data-go="supps">Suppléments</button>
      <button class="tab" data-go="export">Export</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Vues -->
  <div id="view-jour">
    <div class="card" style="margin-bottom:12px">
      <strong>Choisis un jour :</strong>
      <div class="tabs" id="dayTabs" style="margin-top:8px">
        <button class="tab active" data-day="1">J1</button>
        <button class="tab" data-day="2">J2</button>
        <button class="tab" data-day="3">J3</button>
        <button class="tab" data-day="4">J4</button>
        <button class="tab" data-day="5">J5</button>
        <button class="tab" data-day="6">J6</button>
        <button class="tab" data-day="7">J7</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="exoCol">
        <h2>Séance</h2>
        <div id="exos"></div>
      </div>

      <div class="card" id="recCol">
        <h2>Recette du jour</h2>
        <div id="recipe"></div>
      </div>
    </div>
  </div>

  <div id="view-focus" class="hide">
    <div class="card">
      <h2>Mode Focus</h2>
      <p class="muted">Appuie sur chaque série au fur et à mesure. Le minuteur démarre tout seul.</p>
      <div id="focusExos"></div>
    </div>
  </div>

  <div id="view-courses" class="hide">
    <div class="card">
      <h2>Liste de courses <span class="muted">(estimations modifiables)</span></h2>
      <div class="list" id="glist"></div>
      <div class="row">
        <div>
          <button class="edit" id="toggleEdit">Éditer les prix</button>
          <button class="edit" id="loadFR">Charger estimations FR (2025)</button>
        </div>
        <div class="tot" id="gtotal">Total ≈ 0,00 €</div>
      </div>
      <p class="muted" style="margin-top:8px">Les prix sont **moyens** (France) et varient selon magasin/ville. Ajuste au besoin.</p>
    </div>
  </div>

  <div id="view-timer" class="hide">
    <div class="card">
      <h2>Minuteur de repos</h2>
      <p class="muted">Astuce : 90–120 s forces ; 60–90 s hypertrophie ; 30–60 s circuit.</p>
      <div class="row">
        <label>Repos (s) <input id="restInput" type="number" class="mini" value="90" min="15" step="5"></label>
        <button class="bt" id="startTimer">Démarrer</button>
        <div id="timerShow" class="pill">00:00</div>
      </div>
    </div>
  </div>

  <div id="view-checkin" class="hide">
    <div class="card">
      <h2>Check-in quotidien (20–22h)</h2>
      <p class="muted">Colle ce modèle dans le champ ci-dessous et remplis :</p>
      <p class="pill">Sommeil (0–10) | Énergie (0–10) | Humeur (0–10) | Poids (kg) | Perfs gym (exos + reps/temps) | Alimentation (adhérence % + protéines g) | Pas du jour | Étapes accomplies | Obstacles rencontrés | Plan pour demain.</p>
      <textarea id="ck" rows="6" style="width:100%;background:#0f1a30;color:#e9f2ff;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="bt" id="saveCK">Enregistrer</button>
        <div class="muted" id="ckInfo">—</div>
      </div>
    </div>
  </div>

  <div id="view-badges" class="hide">
    <div class="card">
      <h2>Badges</h2>
      <div id="badges"></div>
      <p class="muted">Les badges se débloquent en validant des séries/séances. Si tu **décoches**, l’XP revient en arrière.</p>
    </div>
  </div>

  <div id="view-supps" class="hide">
    <div class="card">
      <h2>Suppléments (optionnels)</h2>
      <ul>
        <li><strong>Whey</strong> : 20–30 g après séance ou pour atteindre ta cible protéines.</li>
        <li><strong>Créatine monohydrate</strong> : 3–5 g/j, n’importe quand (hydratation ok).</li>
        <li><strong>Oméga-3</strong> : selon étiquette (si peu de poissons gras).</li>
        <li><strong>Collagène</strong> : 10 g/j, idéalement avec source Vit C (peau/tendons). <!-- remplace la caféine --></li>
        <li><strong>Vit D</strong> (hiver/faible exposition) : selon avis médical / étiquette.</li>
      </ul>
      <p class="muted">Toujours vérifier tolérance personnelle et contre-indications.</p>
    </div>
  </div>

  <div id="view-export" class="hide">
    <div class="card">
      <h2>Export rapide</h2>
      <p class="muted">Sauvegarde un fichier .json (check-ins, progression des séries, courses, XP).</p>
      <button class="bt" id="doExport">Exporter</button>
      <span id="expInfo" class="muted"></span>
    </div>
  </div>
</div>

<footer class="bar">
  <div class="pill">XP : <span id="xpNum">0</span></div>
  <div class="xpbar"><i id="xpf"></i></div>
  <button class="bt" onclick="resetToday()">Réinitialiser jour</button>
</footer>

<script>
/* ---------- Données ---------- */
const YT = {
  goblet:"https://www.youtube.com/watch?v=JAkdrilhI1g",
  dbPress:"https://www.youtube.com/watch?v=VmB1G1K7v94",
  negPullup:"https://www.youtube.com/watch?v=IQZqPqkpdFE",
  rdl:"https://www.youtube.com/watch?v=uhghy9pFIPY",
  row:"https://www.youtube.com/watch?v=EEFHHOCfHgw",
  deadbug:"https://www.youtube.com/watch?v=4XLEnwUr1d8",
  mcgill:"https://www.youtube.com/watch?v=jZylx81_kfg",
  bulgarian:"https://www.youtube.com/watch?v=2C-uNgKwPLE",
  ohPress:"https://www.youtube.com/watch?v=qEwKCR5JCog",
  facepull:"https://www.youtube.com/watch?v=CSP7YpPv3ds",
  pallof:"https://www.youtube.com/watch?v=Y0e2w0aKOXw",
  latpd:"https://www.youtube.com/watch?v=CAwf7n6Luuc",
  zone2:"https://www.youtube.com/watch?v=yguccI9aocY",
  emomPU:"https://www.youtube.com/watch?v=ELRhRlj1Zaw"
};

const program = {
  1:{
    exos:[
      {name:"Goblet Squat", sets:4, reps:"8–12", rest:90, info:YT.goblet, id:"goblet"},
      {name:"Développé couché haltères", sets:4, reps:"8–12", rest:90, info:YT.dbPress, id:"dbpress"},
      {name:"Tractions assistées / négatives", sets:6, reps:"2–5", rest:90, info:YT.negPullup, id:"pullups"},
      {name:"RDL haltères", sets:3, reps:"10–12", rest:90, info:YT.rdl, id:"rdl"},
      {name:"Rowing 1-bras", sets:3, reps:"10–12", rest:75, info:YT.row, id:"row"},
      {name:"Dead bug (core)", sets:3, reps:"10/10", rest:45, info:YT.deadbug, id:"deadbug"},
    ],
    recipe:{
      title:"Bowl poulet & riz (+ légumes croquants)",
      macros:{kcal:620,p:55,g:70,l:14},
      ings:["250 g riz cuit","150 g blanc de poulet","200 g légumes croquants","10 g huile d’olive","épices"],
      note:"Cuire le riz al dente. Émincer le poulet, assaisonner (paprika, ail). 8–10 min à la poêle. Ajouter les légumes 3–4 min pour garder du croquant, mélanger avec le riz. Arroser d’un filet d’huile, goutter, ajuster sel/poivre. Servir chaud."
    }
  },
  2:{
    exos:[
      {name:"Footing Z2 (aisance)", sets:1, reps:"20–35 min", rest:0, info:YT.zone2, id:"z2"},
      {name:"McGill Big 3", sets:3, reps:"10 s/10 s/10 s", rest:30, info:YT.mcgill, id:"mcgill"},
    ],
    recipe:{
      title:"Wrap dinde-skyr (+ crudités)",
      macros:{kcal:520,p:50,g:55,l:14},
      ings:["2 wraps blé","120 g dinde","150 g skyr 0%","salade, tomates, oignon","moutarde"],
      note:"Tartiner le skyr et la moutarde, ajouter dinde et crudités finement coupées. Rouler serré, toaster 1–2 min par face à feu moyen pour souder et tiédir. Croquer !"
    }
  },
  3:{
    exos:[
      {name:"Bulgarian split squat", sets:3, reps:"8–10 / jambe", rest:90, info:YT.bulgarian, id:"bss"},
      {name:"Développé épaules assis (haltères)", sets:3, reps:"8–12", rest:90, info:YT.ohPress, id:"ohp"},
      {name:"Face pull (élastique)", sets:3, reps:"12–15", rest:60, info:YT.facepull, id:"facepull"},
      {name:"Pallof press (élastique)", sets:3, reps:"10–12 / côté", rest:45, info:YT.pallof, id:"pallof"},
    ],
    recipe:{
      title:"Pâtes 5% bœuf sauce tomate rapide",
      macros:{kcal:650,p:45,g:85,l:14},
      ings:["90 g pâtes crues","200 g bœuf 5%","200 g pulpe tomate","oignon, ail, herbes","parmesan (option)"],
      note:"Saisir l’oignon+ail 2 min, ajouter bœuf émietté (5–6 min). Verser tomate, herbes, réduire 5–8 min. Cuire les pâtes al dente et mélanger. Une pincée de parmesan si tu veux."
    }
  },
  4:{
    exos:[
      {name:"EMOM 20’ : tractions/pompes (alternance)", sets:20, reps:"min 1: 3–5 tractions • min 2: 10–15 pompes", rest:0, info:YT.emomPU, id:"emom"},
      {name:"Lat pulldown (station)", sets:3, reps:"8–12", rest:90, info:YT.latpd, id:"latpd"},
      {name:"Gainage latéral", sets:3, reps:"20–40 s / côté", rest:45, info:"https://www.youtube.com/watch?v=XeN4pEZZJNI", id:"sideplank"},
    ],
    recipe:{
      title:"Chili dinde express (1-pot)",
      macros:{kcal:560,p:48,g:60,l:12},
      ings:["250 g haricots rouges (égouttés)","180 g dinde hachée","300 g concassée tomate","maïs, oignon, épices"],
      note:"Faire revenir oignon+épices 2 min, ajouter dinde (5 min). Verser tomate, haricots, maïs. Mijoter 10–12 min jusqu’à épaississement. Ajuster sel/cumin/piment."
    }
  },
  5:{
    exos:[
      {name:"Hip thrust haltère", sets:4, reps:"8–12", rest:90, info:"https://www.youtube.com/watch?v=29OfN4ztW_g", id:"hipthrust"},
      {name:"Rowing 1-bras", sets:3, reps:"10–12", rest:75, info:YT.row, id:"row2"},
      {name:"RDL haltères", sets:3, reps:"10–12", rest:90, info:YT.rdl, id:"rdl2"},
      {name:"Dead bug (core)", sets:3, reps:"10/10", rest:45, info:YT.deadbug, id:"deadbug2"},
    ],
    recipe:{
      title:"Omelette aux blancs + pommes de terre sautées",
      macros:{kcal:520,p:42,g:55,l:12},
      ings:["6 blancs + 2 œufs","250 g pommes de terre","poivron/oignon","herbes","spray huile"],
      note:"Cubes de pommes de terre 10–12 min poêle couvercle (spray huile). Battre œufs, ajouter légumes, verser, cuire à feu moyen 3–4 min, plier. Sel, poivre, herbes."
    }
  },
  6:{
    exos:[
      {name:"Footing Z2 progressif", sets:1, reps:"25–40 min", rest:0, info:YT.zone2, id:"z2b"},
      {name:"Mobility 10’", sets:1, reps:"hanches, chevilles, T-spine", rest:0, info:YT.mcgill, id:"mob"},
    ],
    recipe:{
      title:"Yaourt skyr + muesli maison protéiné",
      macros:{kcal:480,p:45,g:55,l:10},
      ings:["250 g skyr 0%","40 g flocons d’avoine","20 g whey","fruits (option)","édulcorant"],
      note:"Mélanger skyr et whey, ajouter avoine et fruits. Si tu veux plus croustillant, toaster l’avoine à sec 3–4 min avant."
    }
  },
  7:{
    exos:[
      {name:"Repos actif / marche 8–12k pas", sets:1, reps:"au fil de la journée", rest:0, info:YT.zone2, id:"walk"},
      {name:"Étirements légers 10’", sets:1, reps:"global", rest:0, info:YT.mcgill, id:"stretch"},
    ],
    recipe:{
      title:"Salade complète (thème libre poulet/dinde/œufs)",
      macros:{kcal:520,p:45,g:45,l:16},
      ings:["protéine 150 g","crudités variées","200 g féculent cuit (pâtes/riz/quinoa)","huile d’olive 10 g"],
      note:"Composer une base verte, ajouter féculent tiède, protéine, croquants (maïs, concombre). Assaisonner légère vinaigrette citron/huile 10 g."
    }
  }
};

function baseGroceries(){
  return [
    {k:"Riz (1 kg)", est:2.20},
    {k:"Poulet (1 kg)", est:10.50},
    {k:"Dinde hachée (500 g)", est:4.80},
    {k:"Bœuf 5% (600 g)", est:9.20},
    {k:"Wraps (x8)", est:2.30},
    {k:"Skyr 0% (1 kg)", est:3.50},
    {k:"Haricots rouges (400 g)", est:1.00},
    {k:"Maïs (300 g)", est:1.20},
    {k:"Pulpe/concassée tomate (400 g)", est:1.10},
    {k:"Légumes surgelés (1 kg)", est:2.50},
    {k:"Œufs (12)", est:3.20},
    {k:"Pommes de terre (2 kg)", est:3.40},
    {k:"Avoine (500 g)", est:1.30},
    {k:"Huile d’olive (750 ml)", est:7.90},
    {k:"Épices/Herbes", est:3.00},
    {k:"Whey 1 kg", est:24.00},
    {k:"Créatine 500 g", est:16.00},
    {k:"Oméga-3 (100 caps)", est:14.00},
    {k:"Collagène 500 g", est:20.00},
  ];
}

/* ---------- État & stockage ---------- */
const $ = sel => document.querySelector(sel);
const exState = JSON.parse(localStorage.getItem("exState")||"{}");
const ckState = JSON.parse(localStorage.getItem("ckState")||"{}");
const xpState = JSON.parse(localStorage.getItem("xpState")||"{}");
const groceryState = JSON.parse(localStorage.getItem("grocery")||"{}");
if(!xpState.xp) xpState.xp=0;

let day=1, editingPrices=false;

/* ---------- Rendu vues ---------- */
function fmtMacros(m){ return `
  <div class="macros">
    <span class="macro">≈ ${m.kcal} kcal</span>
    <span class="macro">P ${m.p} g</span>
    <span class="macro">G ${m.g} g</span>
    <span class="macro">L ${m.l} g</span>
  </div>`}

function renderDay(){
  $("#dayTag").textContent = "Jour "+day;
  const D = program[day];

  // Exercices
  const exosHTML = D.exos.map((e,idx)=>{
    const key = `d${day}-${e.id}`;
    const doneSet = exState[key]||[];
    const bubbles = Array.from({length:e.sets}).map((_,i)=>{
      const done = doneSet.includes(i);
      return `<button class="bubble ${done?'done':''}" data-key="${key}" data-i="${i}" title="Série ${i+1}">${i+1}</button>`;
    }).join("");
    return `
      <div class="exo">
        <h3>${e.name} <a class="info" href="${e.info}" target="_blank" rel="noopener" aria-label="Vidéo: ${e.name}">ⓘ</a></h3>
        <div class="meta">
          <span class="chip">${e.reps} reps/temps</span>
          ${e.rest?`<span class="chip">Repos ${e.rest}s</span>`:""}
        </div>
        <div class="series">${bubbles}</div>
        ${e.rest?`<div class="rest">→ Clique pour valider. Minuteur auto: ${e.rest}s</div>`:""}
      </div>
    `;
  }).join("");
  $("#exos").innerHTML = exosHTML;

  // Recette
  const R = D.recipe;
  $("#recipe").innerHTML = `
    <div class="recipe">
      <h3>${R.title}</h3>
      ${fmtMacros(R.macros)}
      <div class="ings">${R.ings.map(i=>`<span class="tag">${i}</span>`).join("")}</div>
      <p class="note">${R.note.replaceAll(". ",".<span class='dot'>•</span> ")}</p>
    </div>
  `;

  // Focus
  $("#focusExos").innerHTML = D.exos.map(e=>{
    const key = `d${day}-${e.id}`;
    const doneSet = exState[key]||[];
    const bubbles = Array.from({length:e.sets}).map((_,i)=>{
      const done = doneSet.includes(i);
      return `<button class="bubble ${done?'done':''}" data-key="${key}" data-i="${i}" title="Série ${i+1}">${i+1}</button>`;
    }).join("");
    return `
      <section class="exo">
        <h3>${e.name} <a class="info" href="${e.info}" target="_blank" rel="noopener">ⓘ</a></h3>
        <div class="meta">
          <span class="chip">${e.reps}</span>
          ${e.rest?`<span class="chip">Repos ${e.rest}s</span>`:""}
        </div>
        <div class="series">${bubbles}</div>
      </section>`;
  }).join("");
  bindSeriesButtons();
}

function bindSeriesButtons(){
  document.querySelectorAll(".bubble").forEach(b=>{
    b.onclick = ()=>{
      const key=b.dataset.key, i=+b.dataset.i;
      const arr = exState[key]||[];
      const wasDone = arr.includes(i);
      if(wasDone){
        exState[key]=arr.filter(x=>x!==i);
        b.classList.remove("done");
        addXP(-5);
      }else{
        arr.push(i); exState[key]=arr;
        b.classList.add("done");
        addXP(5);
        autoTimerFor(key,i);
      }
      localStorage.setItem("exState", JSON.stringify(exState));
    };
  });
}

/* ---------- Minuteur ---------- */
let tInt=null, tRem=0;
function startTimer(sec){
  clearInterval(tInt);
  tRem = sec; showTime();
  tInt = setInterval(()=>{
    tRem--; showTime();
    if(tRem<=0){ clearInterval(tInt); navigator.vibrate?.([60]); $("#timerShow").textContent="Terminé"; }
  },1000);
}
function showTime(){
  const m = String(Math.floor(tRem/60)).padStart(2,"0");
  const s = String(tRem%60).padStart(2,"0");
  $("#timerShow").textContent = `${m}:${s}`;
}
function autoTimerFor(key,i){
  const D = Object.values(program).flatMap(d=>d.exos);
  const found = D.find(ex=>`d${day}-${ex.id}`===key);
  if(found?.rest){ startTimer(found.rest); }
}
$("#startTimer").onclick=()=>startTimer(+$("#restInput").value||60);

/* ---------- XP ---------- */
function addXP(v){
  xpState.xp = Math.max(0, (xpState.xp||0) + v);
  localStorage.setItem("xpState", JSON.stringify(xpState));
  $("#xpNum").textContent = xpState.xp;
  $("#xpf").style.width = Math.min(100, (xpState.xp%100))+"%";
}
$("#xpNum").textContent = xpState.xp; $("#xpf").style.width = Math.min(100, (xpState.xp%100))+"%";

/* ---------- Courses & prix ---------- */
function renderGroceries(){
  const items = groceryState.items || baseGroceries();
  const checks = groceryState.checks || {};
  const showEdit = editingPrices;

  $("#glist").innerHTML = items.map((it,idx)=>{
    const id="g"+idx, checked = !!checks[it.k];
    return `
      <div class="row">
        <label>
          <input type="checkbox" data-k="${it.k}" ${checked?"checked":""}/>
          <span>${it.k}</span>
        </label>
        <div class="price">
          ${showEdit?`<input type="number" step="0.01" class="mini" data-pk="${it.k}" value="${it.est??0}"> €`:`≈ ${Number(it.est??0).toFixed(2)} €`}
        </div>
      </div>`;
  }).join("");

  // total
  const total = items.reduce((s,it)=> s + ((groceryState.checks?.[it.k])? (Number(it.est)||0) : 0), 0);
  $("#gtotal").textContent = `Total ≈ ${total.toFixed(2)} €`;

  // binds
  $("#glist input[type=checkbox]").forEach?.(()=>{});
  document.querySelectorAll("#glist input[type=checkbox]").forEach(cb=>{
    cb.onchange=()=>{
      groceryState.checks = groceryState.checks||{};
      groceryState.checks[cb.dataset.k] = cb.checked;
      localStorage.setItem("grocery", JSON.stringify(groceryState));
      renderGroceries();
    }
  });
  document.querySelectorAll("#glist input[type=number]").forEach(inp=>{
    inp.oninput=()=>{
      const k=inp.dataset.pk;
      const items = groceryState.items || baseGroceries();
      const it = items.find(x=>x.k===k);
      it.est = +inp.value;
      groceryState.items = items;
      localStorage.setItem("grocery", JSON.stringify(groceryState));
      renderGroceries();
    }
  });
}
$("#toggleEdit").onclick=()=>{ editingPrices=!editingPrices; renderGroceries(); }
$("#loadFR").onclick=()=>{ groceryState.items = baseGroceries(); localStorage.setItem("grocery", JSON.stringify(groceryState)); renderGroceries(); }

/* ---------- Check-in ---------- */
$("#saveCK").onclick=()=>{
  const txt=$("#ck").value.trim();
  if(!txt){ $("#ckInfo").textContent="Rien à enregistrer."; return; }
  const d = new Date().toISOString().slice(0,10);
  ckState[d]=txt;
  localStorage.setItem("ckState", JSON.stringify(ckState));
  $("#ckInfo").innerHTML=`<span class="ok">Enregistré pour ${d}</span>`;
}

/* ---------- Export ---------- */
$("#doExport").onclick=()=>{
  const data = { exState, ckState, xpState, groceryState, version:"1.2+" };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="sante-changement-data.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
  $("#expInfo").textContent="— export OK";
}

/* ---------- Navigation ---------- */
function switchView(id){
  ["jour","focus","courses","timer","checkin","badges","supps","export"].forEach(v=>{
    const el = $("#view-"+v); if(!el) return;
    if(v===id) el.classList.remove("hide"); else el.classList.add("hide");
  });
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelector(`.tab[data-go="${id}"]`)?.classList.add("active");
}
document.querySelectorAll("[data-go]").forEach(t=> t.onclick=()=> switchView(t.dataset.go) );

document.querySelectorAll("#dayTabs .tab").forEach(b=>{
  b.onclick=()=>{ document.querySelectorAll("#dayTabs .tab").forEach(x=>x.classList.remove("active")); b.classList.add("active"); day=+b.dataset.day; renderDay(); }
});

/* ---------- Réinit jour ---------- */
function resetToday(){
  const keys = program[day].exos.map(e=>`d${day}-${e.id}`);
  keys.forEach(k=> delete exState[k]);
  localStorage.setItem("exState", JSON.stringify(exState));
  renderDay();
}

/* ---------- Init ---------- */
renderDay(); renderGroceries();

/* ---------- PWA ---------- */
if("serviceWorker" in navigator){ navigator.serviceWorker.register("./service-worker.js"); }
</script>
</body>
</html>
